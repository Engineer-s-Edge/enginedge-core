# Hybrid dev docker-compose: spin up infra + optional app containers.
# You can run core/worker nodes/frontend locally, while Kafka/Redis/Mongo/MinIO/Postgres run here.
# Override defaults in .env

name: enginedge-dev

networks:
  enginedge:
    driver: bridge

volumes:
  mongo_data:
  minio_data:
  postgres_data:
  redis_data:
  wolfram_state:

services:
  # --- Databases / Storage ---
  mongodb:
    image: mongo:7
    container_name: mongodb
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    networks: [enginedge]
    volumes:
      - mongo_data:/data/db

  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    networks: [enginedge]
    volumes:
      - minio_data:/data

  postgres:
    image: postgres:14
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-enginedge}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks: [enginedge]
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # --- Messaging / Cache ---
  redis:
    image: redis:7
    container_name: enginedge-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks: [enginedge]
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  kafka:
    image: bitnami/kafka:3.7
    container_name: kafka
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:${KAFKA_EXTERNAL_PORT:-9094}
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      ALLOW_PLAINTEXT_LISTENER: "yes"
    ports:
      - "${KAFKA_INTERNAL_PORT:-9092}:9092"   # optional (inside docker network)
      - "${KAFKA_EXTERNAL_PORT:-9094}:9094"   # host access
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    ports:
      - "${KAFKA_UI_PORT:-8085}:8080"
    depends_on:
      - kafka
    networks: [enginedge]

  # --- Optional app services (can run locally instead) ---
  hexagon:
    build:
      context: ../hexagon
      dockerfile: Dockerfile
    container_name: hexagon
    environment:
      NODE_ENV: development
      PORT: 3000
      MONGODB_URI: mongodb://mongodb:27017/enginedge-hexagon
      REDIS_URL: redis://enginedge-redis:6379/0
      REDIS_KEY_PREFIX: hexagon:
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: enginedge-hexagon
      KAFKA_GROUP_ID: hexagon-orchestrator
      # Worker URLs
      ASSISTANT_WORKER_URL: http://assistant-worker:3001
      TOOLS_WORKER_URL: http://agent-tool-worker:3002
      DATA_WORKER_URL: http://data-processing-worker:3003
      INTERVIEW_WORKER_URL: http://interview-worker:3004
      LATEX_WORKER_URL: http://latex-worker:3005
      RESUME_WORKER_URL: http://resume-worker:3006
      SCHEDULING_WORKER_URL: http://scheduling-worker:3000
      IDENTITY_SERVICE_URL: http://identity-worker:3000
      NEWS_WORKER_URL: http://news-worker:3007
      # Worker discovery
      WORKER_DISCOVERY_MODE: static
      WORKER_HEALTH_CHECK_INTERVAL: 30000
      WORKER_REQUEST_TIMEOUT: 60000
      # Workflow configuration
      WORKFLOW_MAX_DURATION: 300000
      WORKFLOW_RETRY_ATTEMPTS: 3
      WORKFLOW_RETRY_DELAY: 5000
    ports:
      - "${CONTROL_PLANE_PORT:-3000}:3000"
    depends_on:
      - mongodb
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- Hexagonal Worker Nodes (optional - can run locally instead) ---
  assistant-worker:
    build:
      context: ../../enginedge-workers/assistant-worker
    container_name: assistant-worker
    environment:
      NODE_ENV: development
      PORT: 3001
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://enginedge-redis:6379/2
      REDIS_KEY_PREFIX: assistant:
    ports:
      - "${LLM_WORKER_PORT:-3001}:3001"
    depends_on:
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  agent-tool-worker:
    build:
      context: ../../enginedge-workers/agent-tool-worker
    container_name: agent-tool-worker
    environment:
      NODE_ENV: development
      PORT: 3002
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://enginedge-redis:6379/3
      REDIS_KEY_PREFIX: agent-tool:
    ports:
      - "${AGENT_TOOL_WORKER_PORT:-3002}:3002"
    depends_on:
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  data-processing-worker:
    build:
      context: ../../enginedge-workers/data-processing-worker
    container_name: data-processing-worker
    environment:
      NODE_ENV: development
      PORT: 3003
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://enginedge-redis:6379/4
      REDIS_KEY_PREFIX: data-processing:
    ports:
      - "${DATA_PROCESSING_WORKER_PORT:-3003}:3003"
    depends_on:
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  interview-worker:
    build:
      context: ../../enginedge-workers/interview-worker
    container_name: interview-worker
    environment:
      NODE_ENV: development
      PORT: 3004
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://enginedge-redis:6379/5
      REDIS_KEY_PREFIX: interview:
    ports:
      - "${INTERVIEW_WORKER_PORT:-3004}:3004"
    depends_on:
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  latex-worker:
    build:
      context: ../../enginedge-workers/latex-worker
    container_name: latex-worker
    environment:
      NODE_ENV: development
      PORT: 3005
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://enginedge-redis:6379/6
      REDIS_KEY_PREFIX: latex:
    ports:
      - "${LATEX_WORKER_PORT:-3005}:3005"
    depends_on:
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  resume-worker:
    build:
      context: ../../enginedge-workers/resume-worker
    container_name: resume-worker
    environment:
      NODE_ENV: development
      PORT: 3006
      KAFKA_BROKERS: kafka:9092
      MONGODB_URI: mongodb://mongodb:27017/resume-worker
      REDIS_URL: redis://enginedge-redis:6379/7
      REDIS_KEY_PREFIX: resume:
      RESUME_NLP_SERVICE_URL: http://spacy-service:8001
    ports:
      - "${RESUME_WORKER_PORT:-3006}:3006"
    depends_on:
      - kafka
      - mongodb
      - redis
      - spacy-service
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  spacy-service:
    build:
      context: ../../enginedge-workers/spacy-service
    container_name: spacy-service
    environment:
      PORT: 8001
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${SPACY_SERVICE_PORT:-8001}:8001"
    depends_on:
      - kafka
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  identity-worker:
    build:
      context: ../../enginedge-workers/identity-worker
    container_name: identity-worker
    environment:
      NODE_ENV: development
      PORT: 3000
      MONGODB_URI: mongodb://mongodb:27017/identity-service
      REDIS_URL: redis://enginedge-redis:6379/8
      REDIS_KEY_PREFIX: identity:
    ports:
      - "${IDENTITY_WORKER_PORT:-3000}:3000"
    depends_on:
      - mongodb
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  news-worker:
    build:
      context: ../../enginedge-workers/news-worker
    container_name: news-worker
    environment:
      NODE_ENV: development
      PORT: 3007
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://enginedge-redis:6379/9
      REDIS_KEY_PREFIX: news:
    ports:
      - "${NEWS_WORKER_PORT:-3007}:3007"
    depends_on:
      - kafka
      - redis
    networks: [enginedge]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  scheduling-model:
    build:
      context: ../../EnginEdge-monorepo/scheduling_model
    container_name: scheduling-model
    environment:
      PORT: 8000
      REDIS_URL: redis://enginedge-redis:6379/0
    ports:
      - "${SCHEDULING_MODEL_PORT:-8000}:8000"
    depends_on:
      - redis
    networks: [enginedge]

  wolfram-kernel:
    build:
      context: ../../EnginEdge-monorepo/local-kernel
      args:
        WOLFRAM_DOWNLOAD_URL: ${WOLFRAM_DOWNLOAD_URL:-}
    container_name: wolfram-kernel
    ports:
      # App listens on 5000 internally; expose on host-configurable port
      - "${WOLFRAM_KERNEL_PORT:-5001}:5000"
    networks: [enginedge]
    environment:
      HOME: /home/appuser
      WOLFRAM_USERBASE: /home/appuser/.WolframEngine
    volumes:
      - wolfram_state:/home/appuser/.WolframEngine
      - wolfram_state:/home/appuser/.Wolfram
